<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/communication-icons.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../accounting/accounting.js">

<dom-module id="nc-discount-dialog">
  <template>
    <style>
      paper-icon-button {
        width: 60px;
        height: 60px;
      }

      paper-input{
        --paper-input-container-input: {
          font-size: 1.5em;
          text-align: center;
        };
        --paper-input-suffix: {
          font-size: 1.5em;
        };
        
      }

      paper-dialog.modalNoApp > div.header {
        @apply --layout-horizontal;
        @apply --layout-center;
      }

      paper-dialog.modalNoApp > div.header > iron-icon {
        margin-right: 12px;
      }

      paper-dialog.modalNoApp > div.content {

      }

      paper-dialog.modalNoApp > div.content > div.content-percentage {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-center-justified;
      }

      paper-dialog.modalNoApp > div.content > div.content-percentage  > div.min {
        @apply --layout-vertical;
        @apply --layout-center;
      }
      
      paper-dialog.modalNoApp > div.content > div.content-percentage  > div.max {
        @apply --layout-vertical;
        @apply --layout-center;
      }

      paper-dialog.modalNoApp > div.content > div.content-percentage > div.percentage{
        width: 120px;
      }

      paper-dialog.modalNoApp > div.content > div.content-amount {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-center-justified;
      }

      paper-dialog.modalNoApp > div.content > div.content-amount > div.amount {
        width: 120px;
      }
    </style>
    
    <paper-dialog id="discountDialog" class="modalNoApp" modal entry-animation="scale-up-animation">
      <iron-a11y-keys id="a11ySignIn" keys="enter" on-keys-pressed="_accept"></iron-a11y-keys>
      <div class="header">
        <h3>[[discountData.name]]</h3>
      </div>
      <div class="content">
        <div class="content-title">
          <div>[[_formatNumber(amountToApplyDiscount)]] €</div>
        </div>
        <div class="content-percentage">
          <div class="min">
            <div>{{localize('DISCOUNT_DIALOG_MIN')}}</div>
            <div>[[discountData.minValue]]%</div>
          </div>
          <paper-icon-button icon="remove-circle" style="color: var(--app-secondary-color);" on-tap="_percentageDec"></paper-icon-button>
          <div class="percentage">
            <paper-input id="percentage" on-focused-changed="_percantageFocused" on-value-changed="_percentageChanged" allowed-pattern="[0-9 . ,]" error-message="{{localize('INPUT_ERROR_REQUIRED')}}" value="{{formData.percentage}}" required>
              <div slot="suffix">%</div>
            </paper-input>
          </div>
          <paper-icon-button icon="add-circle" style="color: var(--app-secondary-color);" on-tap="_percentageInc"></paper-icon-button>
          <div class="max">
              <div>{{localize('DISCOUNT_DIALOG_MAX')}}</div>
            <div>[[discountData.maxValue]]%</div>
          </div>
        </div>
        <div class="content-amount">
          <div class="amount">
            <paper-input id="amount" on-focused-changed="_amountFocused"  on-value-changed="_amountChanged" allowed-pattern="[0-9 . ,]" error-message="{{localize('INPUT_ERROR_REQUIRED')}}" value="{{formData.amount}}" required>
              <div slot="suffix">€</div>
            </paper-input>
          </div>
        </div>
      </div>
      <div class="buttons">
        <paper-button raised dialog-dismiss>{{localize('BUTTON_CLOSE')}}</paper-button>
        <paper-button raised disabled$="[[loading]]" on-tap="_accept">{{localize('BUTTON_ACCEPT')}}</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    
    class NcDiscountDialog extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
      static get is() { return 'nc-discount-dialog'; }
      static get properties() {
        return {
          language: {
            type: String
          },
          formData: {
            type: Object
          },
          discountData: {
            type: Object,
            value: {}
          }, 
          discountIncreasePercent: Number,
          amountToApplyDiscount: Number
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.useKeyIfMissing = true;
        this.loadResources(this.resolveUrl('static/translations.json'));
      }

      open(){
        /* Fix Modal paper-dialog appears behind its backdrop */
        var app = document.querySelector('body').firstElementChild.shadowRoot;
        Polymer.dom(app).appendChild(this.$.discountDialog);
        
        this.formData = {};
        this.set('formData.percentage', this._formatNumber(this.discountData.percentage));

        this._calcAmount(this.formData.percentage);

        this.$.percentage.invalid = false;
        this.$.amount.invalid = false;

        this.$.discountDialog.open();
      }

      close(){
        this.$.discountDialog.close();
      }

      _percentageDec(){
        if (Number(this.formData.percentage.replace(',','.')) - Number(this.discountIncreasePercent) >= Number(this.discountData.minValue)){
          this.set('formData.percentage', this._formatNumber(Number(this.formData.percentage.replace(',','.')) - Number(this.discountIncreasePercent)));
          this._calcAmount(this.formData.percentage);
        }
      }

      _percentageInc(){
        if (Number(this.formData.percentage.replace(',','.')) + Number(this.discountIncreasePercent) <= Number(this.discountData.maxValue)){
          this.set('formData.percentage', this._formatNumber(Number(this.formData.percentage.replace(',','.')) + Number(this.discountIncreasePercent)));
          this._calcAmount(this.formData.percentage);
        }
      }

      _percentageChanged(e){
        let percentage = e.detail.value;
        percentage = percentage.replace(',','.');
        this.set('formData.percentage', percentage.replace('.',','));

        this._calcAmount(percentage);
      }

      _amountChanged(e){
        let amount = e.detail.value;
        amount = amount.replace(',','.');
        this.set('formData.amount', amount.replace('.',','));

        this._calcPercentage(amount);
      }

      _calcAmount(percentage){
        if (!this.formData) return;
        this.set('formData.amount', this._formatNumber((this.amountToApplyDiscount * percentage.replace(',','.')) / 100));
      }

      _calcPercentage(amount){
        if (!this.formData) return;
        this.set('formData.percentage', this._formatNumber((amount.replace(',','.') * 100) / this.amountToApplyDiscount));
      }

      _formatNumber(number) {
        let numberText = "";
        numberText = accounting.formatNumber(number, 2, ".", ",")
        return numberText;
      }

      _percantageFocused(e){
        if (e.detail.value === true){
          this.$.percentage.inputElement.inputElement.select();
        }
      }

      _amountFocused(e){
        if (e.detail.value === true){
          this.$.amount.inputElement.inputElement.select();
        }
      }

      _accept(){
        if (this.$.percentage.validate() && this.$.amount.validate()) {
          if (this._percentageValidate() && this._amountValidate()){
            this.formData.percentage = Number(this.formData.percentage.replace(',','.'))
            this.formData.amount = Number(this.formData.amount.replace(',','.'))
            this.dispatchEvent(new CustomEvent('discount-accepted', {detail: {discount:this.formData, discountData: this.discountData}, bubbles: true, composed: true }));
            this.$.discountDialog.close();
          }
        }
      }

      _percentageValidate(){
        let regexp1 = /^\d+(\.)$/;
        let regexp2 = /^\d+(\.\d{1,2})?$/;

        let isValid = true;
        let percentage = this.$.percentage;
        let percentageValue = String(percentage.value).replace(',','.');


        if (percentageValue != "") {
          if (!regexp1.test(percentageValue) && (!regexp2.test(percentageValue))) {
            isValid = false;
            percentage.errorMessage = this.localize('INPUT_ERROR_NUMBER_INVALID');
          } else{
            if (((parseFloat(percentageValue) < this.discountData.minValue)) || (parseFloat(percentageValue) > this.discountData.maxValue)){
              isValid = false;
              percentage.errorMessage = this.localize('INPUT_ERROR_NUMBER_EXCESS');
            }
          }

        } else{
          percentage.errorMessage = this.localize('INPUT_ERROR_REQUIRED');
          isValid = false;
        }

        if (!isValid){
          percentage.invalid = true;
          percentage.focus();
        }
        return isValid;

      }

      _amountValidate(){
        let regexp1 = /^\d+(\.)$/;
        let regexp2 = /^\d+(\.\d{1,2})?$/;

        let isValid = true;
        let amount = this.$.amount;
        let amountValue = String(amount.value).replace(',','.')


        if (amountValue != "") {
          if (!regexp1.test(amountValue) && (!regexp2.test(amountValue))) {
            isValid = false;
            amount.errorMessage = this.localize('INPUT_ERROR_NUMBER_INVALID');
          }
        }
        else{
          amount.errorMessage = this.localize('INPUT_ERROR_REQUIRED');
          isValid = false;
        }

        if (!isValid){
          amount.invalid = true;
          amount.focus();
        }
        return isValid;

      }

    }

    window.customElements.define(NcDiscountDialog.is, NcDiscountDialog);
  </script>
</dom-module>
